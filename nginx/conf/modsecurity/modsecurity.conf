# =======================================================
# ModSecurity 主配置文件
# 基于 ModSecurity v3 推荐配置
# =======================================================

# -- 规则引擎 --
SecRuleEngine on

# -- 请求体处理 --
SecRequestBodyAccess On

# XML 请求体解析器
SecRule REQUEST_HEADERS:Content-Type "^(?:application(?:/soap\+|/)|text/)xml" \
     "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

# JSON 请求体解析器
SecRule REQUEST_HEADERS:Content-Type "^application/json" \
     "id:'200001',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

# 请求体大小限制（13MB 含文件上传，256KB 不含文件）
# 中文 UTF-8 每字符占 3 字节，需要更大的非文件请求体限制
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 262144
SecRequestBodyLimitAction Reject

# JSON 深度限制（防止 JSON 嵌套攻击）
SecRequestBodyJsonDepthLimit 512

# 参数数量限制
SecArgumentsLimit 1000

SecRule &ARGS "@ge 1000" \
"id:'200007', phase:2,t:none,log,deny,status:400,msg:'Failed to fully parse request body due to large argument count',severity:2"

# 验证请求体是否正确解析
SecRule REQBODY_ERROR "!@eq 0" \
"id:'200002', phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}',severity:2"

# Multipart 严格验证
SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
"id:'200003',phase:2,t:none,log,deny,status:400, \
msg:'Multipart request body failed strict validation: \
PE %{REQBODY_PROCESSOR_ERROR}, \
BQ %{MULTIPART_BOUNDARY_QUOTED}, \
BW %{MULTIPART_BOUNDARY_WHITESPACE}, \
DB %{MULTIPART_DATA_BEFORE}, \
DA %{MULTIPART_DATA_AFTER}, \
HF %{MULTIPART_HEADER_FOLDING}, \
LF %{MULTIPART_LF_LINE}, \
SM %{MULTIPART_MISSING_SEMICOLON}, \
IQ %{MULTIPART_INVALID_QUOTING}, \
IP %{MULTIPART_INVALID_PART}, \
IH %{MULTIPART_INVALID_HEADER_FOLDING}, \
FL %{MULTIPART_FILE_LIMIT_EXCEEDED}'"

SecRule MULTIPART_UNMATCHED_BOUNDARY "@eq 1" \
    "id:'200004',phase:2,t:none,log,deny,msg:'Multipart parser detected a possible unmatched boundary.'"

# PCRE 调优（防止 RegEx DoS，同时避免复杂规则误报）
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

SecRule TX:/^MSC_/ "!@streq 0" \
        "id:'200005',phase:2,t:none,deny,msg:'ModSecurity internal error flagged: %{MATCHED_VAR_NAME}'"

# -- 响应体处理 --
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# -- 文件系统配置 --
SecTmpDir /tmp/
SecDataDir /tmp/

# Unicode 映射（改善 UTF-8 处理和防绕过）
# 使用简体中文代码页 20936（GB2312）替代 US-ASCII（20127）
# 确保简体中文字符正确规范化，避免中文表单提交误报
# 如需繁体中文支持，可改用 950（Big5）
SecUnicodeMapFile unicode.mapping 20936

# -- 审计日志配置 --
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Concurrent
SecAuditLog %NGINX_DIR%/logs/modsec_audit.log
SecAuditLogStorageDir %NGINX_DIR%/logs/modsec_audit/

# -- 其他配置 --
SecArgumentSeparator &
SecCookieFormat 0
SecStatusEngine Off
