# =======================================================
# OWASP CRS 配置文件 (基于 CRS v4.x)
# 自定义偏好级别和规则设置
# 此文件在 Docker 构建时会被复制到 OWASP 规则目录
# =======================================================

# 使用自包含模式（Self-Contained Mode），匹配即拦截返回 403
SecDefaultAction "phase:1,log,auditlog,deny,status:403"
SecDefaultAction "phase:2,log,auditlog,deny,status:403"

# 偏好级别设置为 3（高安全性）
# 级别 1: 默认，适合初学者
# 级别 2: 中级，更完整的覆盖
# 级别 3: 高级，更严格的规则和关键字列表
# 级别 4: 最高，非常严格（可能产生大量误报）
SecAction \
    "id:900000,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.4.0',\
    setvar:tx.blocking_paranoia_level=3"

SecAction \
    "id:900001,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.4.0',\
    setvar:tx.detection_paranoia_level=3"

# 仅允许 HTTP/2 和 HTTP/3（禁用 HTTP/1.0 和 HTTP/1.1 提高安全性）
SecAction \
    "id:900230,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.4.0',\
    setvar:'tx.allowed_http_versions=HTTP/2 HTTP/2.0 HTTP/3 HTTP/3.0'"

# 禁止访问的文件扩展名
SecAction \
    "id:900240,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.4.0',\
    setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/'"

# CRS 版本标记（必须保留，CRS 通过此变量验证配置已加载）
SecAction \
    "id:900990,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.4.0',\
    setvar:tx.crs_setup_version=440"
