# PCI DSS åˆè§„é…ç½®

> **PCI DSS v4.0** â€” æ”¯ä»˜å¡è¡Œä¸šæ•°æ®å®‰å…¨æ ‡å‡†

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [åˆè§„è¦æ±‚å¯¹ç…§](#åˆè§„è¦æ±‚å¯¹ç…§)
  - [è¦æ±‚ 1ï¼šå®‰è£…å’Œç»´æŠ¤ç½‘ç»œå®‰å…¨æ§åˆ¶](#è¦æ±‚-1å®‰è£…å’Œç»´æŠ¤ç½‘ç»œå®‰å…¨æ§åˆ¶)
  - [è¦æ±‚ 2ï¼šå¯¹æ‰€æœ‰ç³»ç»Ÿç»„ä»¶åº”ç”¨å®‰å…¨é…ç½®](#è¦æ±‚-2å¯¹æ‰€æœ‰ç³»ç»Ÿç»„ä»¶åº”ç”¨å®‰å…¨é…ç½®)
  - [è¦æ±‚ 3ï¼šä¿æŠ¤å­˜å‚¨çš„è´¦æˆ·æ•°æ®](#è¦æ±‚-3ä¿æŠ¤å­˜å‚¨çš„è´¦æˆ·æ•°æ®)
  - [è¦æ±‚ 4ï¼šä½¿ç”¨å¼ºåŠ å¯†ä¿æŠ¤ä¼ è¾“ä¸­çš„æŒå¡äººæ•°æ®](#è¦æ±‚-4ä½¿ç”¨å¼ºåŠ å¯†ä¿æŠ¤ä¼ è¾“ä¸­çš„æŒå¡äººæ•°æ®)
  - [è¦æ±‚ 5ï¼šä¿æŠ¤æ‰€æœ‰ç³»ç»Ÿå…å—æ¶æ„è½¯ä»¶ä¾µå®³](#è¦æ±‚-5ä¿æŠ¤æ‰€æœ‰ç³»ç»Ÿå…å—æ¶æ„è½¯ä»¶ä¾µå®³)
  - [è¦æ±‚ 6ï¼šå¼€å‘å’Œç»´æŠ¤å®‰å…¨çš„ç³»ç»Ÿå’Œè½¯ä»¶](#è¦æ±‚-6å¼€å‘å’Œç»´æŠ¤å®‰å…¨çš„ç³»ç»Ÿå’Œè½¯ä»¶)
  - [è¦æ±‚ 7ï¼šæŒ‰ä¸šåŠ¡éœ€è¦é™åˆ¶å¯¹ç³»ç»Ÿç»„ä»¶çš„è®¿é—®](#è¦æ±‚-7æŒ‰ä¸šåŠ¡éœ€è¦é™åˆ¶å¯¹ç³»ç»Ÿç»„ä»¶çš„è®¿é—®)
  - [è¦æ±‚ 8ï¼šè¯†åˆ«ç”¨æˆ·å¹¶éªŒè¯å¯¹ç³»ç»Ÿç»„ä»¶çš„è®¿é—®](#è¦æ±‚-8è¯†åˆ«ç”¨æˆ·å¹¶éªŒè¯å¯¹ç³»ç»Ÿç»„ä»¶çš„è®¿é—®)
  - [è¦æ±‚ 10ï¼šè®°å½•å’Œç›‘æ§å¯¹ç³»ç»Ÿç»„ä»¶çš„æ‰€æœ‰è®¿é—®](#è¦æ±‚-10è®°å½•å’Œç›‘æ§å¯¹ç³»ç»Ÿç»„ä»¶çš„æ‰€æœ‰è®¿é—®)
  - [è¦æ±‚ 11ï¼šå®šæœŸæµ‹è¯•å®‰å…¨ç³»ç»Ÿå’Œæµç¨‹](#è¦æ±‚-11å®šæœŸæµ‹è¯•å®‰å…¨ç³»ç»Ÿå’Œæµç¨‹)
  - [è¦æ±‚ 12ï¼šé€šè¿‡ç­–ç•¥æ”¯æŒä¿¡æ¯å®‰å…¨](#è¦æ±‚-12é€šè¿‡ç­–ç•¥æ”¯æŒä¿¡æ¯å®‰å…¨)
- [éªŒè¯ PCI DSS åˆè§„](#éªŒè¯-pci-dss-åˆè§„)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

---

## æ¦‚è¿°

PCI DSSï¼ˆPayment Card Industry Data Security Standardï¼‰æ˜¯æ”¯ä»˜å¡è¡Œä¸šçš„å…¨çƒå®‰å…¨æ ‡å‡†ï¼Œé€‚ç”¨äºæ‰€æœ‰å¤„ç†ã€å­˜å‚¨æˆ–ä¼ è¾“æŒå¡äººæ•°æ®çš„å®ä½“ã€‚æœ¬é¡¹ç›®çš„ Nginx å®‰å…¨éƒ¨ç½²æ–¹æ¡ˆå®ç°äº† PCI DSS v4.0 ä¸­ä¸ Web æœåŠ¡å™¨ç›¸å…³çš„å¤šé¡¹è¦æ±‚ã€‚

**åˆè§„è¦†ç›–æ¦‚è¦**ï¼š

| PCI DSS è¦æ±‚ | ç›¸å…³æ€§ | æœ¬é¡¹ç›®è¦†ç›– |
|-------------|--------|-----------|
| è¦æ±‚ 1ï¼šç½‘ç»œå®‰å…¨æ§åˆ¶ | é«˜ | âœ… Docker ç½‘ç»œéš”ç¦» + iptables |
| è¦æ±‚ 2ï¼šå®‰å…¨é…ç½® | é«˜ | âœ… CIS åŸºå‡†åŠ å›º |
| è¦æ±‚ 3ï¼šä¿æŠ¤å­˜å‚¨æ•°æ® | ä¸­ | âœ… Docker Secrets |
| è¦æ±‚ 4ï¼šä¼ è¾“åŠ å¯† | é«˜ | âœ… TLS 1.2/1.3 + å¼ºåŠ å¯†å¥—ä»¶ |
| è¦æ±‚ 5ï¼šæ¶æ„è½¯ä»¶é˜²æŠ¤ | é«˜ | âœ… ModSecurity WAF |
| è¦æ±‚ 6ï¼šå®‰å…¨å¼€å‘å’Œç»´æŠ¤ | é«˜ | âœ… å®‰å…¨æ„å»º + è¡¥ä¸ç®¡ç† |
| è¦æ±‚ 7ï¼šæœ€å°æƒé™ | é«˜ | âœ… é root + Capabilities é™åˆ¶ |
| è¦æ±‚ 8ï¼šè®¤è¯å’Œè®¿é—® | ä¸­ | âœ… é root ç”¨æˆ· + æƒé™åˆ†ç¦» |
| è¦æ±‚ 10ï¼šæ—¥å¿—å’Œç›‘æ§ | é«˜ | âœ… å®¡è®¡æ—¥å¿— + é›†ä¸­æ—¥å¿— |
| è¦æ±‚ 11ï¼šå®‰å…¨æµ‹è¯• | é«˜ | âœ… è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬ |
| è¦æ±‚ 12ï¼šå®‰å…¨ç­–ç•¥ | ä¸­ | ğŸ“‹ æä¾›ç­–ç•¥æ¨¡æ¿å’ŒæŒ‡å— |

## åˆè§„è¦æ±‚å¯¹ç…§

### è¦æ±‚ 1ï¼šå®‰è£…å’Œç»´æŠ¤ç½‘ç»œå®‰å…¨æ§åˆ¶

> å®‰è£…å’Œç»´æŠ¤é˜²ç«å¢™é…ç½®ä»¥ä¿æŠ¤æŒå¡äººæ•°æ®

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 1.2.1 | é™åˆ¶å…¥ç«™å’Œå‡ºç«™æµé‡ | Docker ç½‘ç»œç­–ç•¥é™åˆ¶å®¹å™¨é—´é€šä¿¡ | `docker-compose.yml`ã€`daemon.json` |
| 1.2.5 | é™åˆ¶ç½‘ç»œè¿æ¥ | `icc: false` ç¦æ­¢å®¹å™¨é—´é€šä¿¡ | `daemon.json` |
| 1.3.1 | å…¥ç«™æµé‡é™åˆ¶åœ¨å¿…è¦ç«¯å£ | ä»…æš´éœ² 80/443 ç«¯å£ | `docker-compose.yml` |
| 1.3.2 | å‡ºç«™æµé‡é™åˆ¶åœ¨å¿…è¦èŒƒå›´ | Seccomp é™åˆ¶ç½‘ç»œç³»ç»Ÿè°ƒç”¨ | `nginx-seccomp.json` |
| 1.4.1 | åœ¨ä¸å¯ä¿¡ç½‘ç»œé—´å®æ–½é˜²ç«å¢™ | Docker è‡ªå®šä¹‰ bridge ç½‘ç»œéš”ç¦» | `docker-compose.yml` |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# éªŒè¯å®¹å™¨é—´é€šä¿¡å·²ç¦æ­¢
docker network inspect bridge | grep "com.docker.network.bridge.enable_icc"

# éªŒè¯ä»…æš´éœ²å¿…è¦ç«¯å£
docker port nginx-secure

# éªŒè¯ iptables è§„åˆ™
sudo iptables -L DOCKER -n
```

### è¦æ±‚ 2ï¼šå¯¹æ‰€æœ‰ç³»ç»Ÿç»„ä»¶åº”ç”¨å®‰å…¨é…ç½®

> ä¸ä½¿ç”¨ä¾›åº”å•†æä¾›çš„é»˜è®¤å¯†ç å’Œå…¶ä»–å®‰å…¨å‚æ•°

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 2.2.1 | ä»…å¯ç”¨å¿…è¦çš„åŠŸèƒ½å’ŒæœåŠ¡ | æœ€å°åŒ– Nginx æ¨¡å—ç¼–è¯‘ | `Dockerfile` |
| 2.2.2 | ä»…å¯ç”¨å¿…è¦çš„åè®®å’Œç«¯å£ | ä»…å¯ç”¨ HTTP/HTTPS åè®® | `nginx.conf` |
| 2.2.3 | ä½¿ç”¨å®‰å…¨é…ç½®æ ‡å‡† | CIS Docker + CIS Nginx åŸºå‡† | é¡¹ç›®å…¨éƒ¨æ–‡ä»¶ |
| 2.2.4 | é…ç½®ç³»ç»Ÿå®‰å…¨å‚æ•° | å†…æ ¸å‚æ•°ã€sysctl è°ƒä¼˜ | `docker-compose.yml` |
| 2.2.5 | åˆ é™¤ä¸å¿…è¦çš„åŠŸèƒ½ | å¤šé˜¶æ®µæ„å»ºç§»é™¤å¼€å‘å·¥å…· | `Dockerfile` |
| 2.2.7 | åŠ å¯†æ‰€æœ‰éæ§åˆ¶å°ç®¡ç†è®¿é—® | å¼ºåˆ¶ HTTPS é‡å®šå‘ | `nginx.conf` |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# éªŒè¯æœ€å°åŒ–æ¨¡å—
docker exec nginx-secure nginx -V 2>&1 | grep -c "without"

# éªŒè¯æ— é»˜è®¤é¡µé¢æ³„éœ²
curl -s https://localhost:8443/ | grep -i "welcome to nginx"
# é¢„æœŸï¼šæ— è¾“å‡º

# éªŒè¯å¼ºåˆ¶ HTTPS
curl -sI http://localhost:8080/ | grep "Location"
# é¢„æœŸï¼šLocation: https://...
```

### è¦æ±‚ 3ï¼šä¿æŠ¤å­˜å‚¨çš„è´¦æˆ·æ•°æ®

> ä¿æŠ¤å­˜å‚¨çš„æŒå¡äººæ•°æ®

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 3.4.1 | ä½¿ç”¨å¼ºåŠ å¯†ä¿æŠ¤å­˜å‚¨çš„æ•°æ® | SSL è¯ä¹¦å’Œå¯†é’¥é€šè¿‡ Docker Secrets ç®¡ç† | `docker-compose-secrets.yml` |
| 3.5.1 | ä¿æŠ¤åŠ å¯†å¯†é’¥ | å¯†é’¥å­˜å‚¨åœ¨ tmpfs å†…å­˜æ–‡ä»¶ç³»ç»Ÿä¸­ | `docker-compose-secrets.yml` |
| 3.5.1.2 | é™åˆ¶å¯†é’¥è®¿é—® | æ–‡ä»¶æƒé™é™åˆ¶ä¸ºä»… root å¯è¯» | `Dockerfile`ã€`docker-entrypoint.sh` |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# éªŒè¯ Secrets æŒ‚è½½ä¸º tmpfs
docker exec nginx-secure mount | grep secrets

# éªŒè¯å¯†é’¥æ–‡ä»¶æƒé™
docker exec nginx-secure ls -la /run/secrets/
# é¢„æœŸï¼šå¯†é’¥æ–‡ä»¶æƒé™ä¸º 400 æˆ– 440

# éªŒè¯ç¯å¢ƒå˜é‡ä¸­æ²¡æœ‰å¯†é’¥
docker inspect nginx-secure | grep -iE "key|password|secret" | grep -v "SecurityOpt\|secret_"
```

### è¦æ±‚ 4ï¼šä½¿ç”¨å¼ºåŠ å¯†ä¿æŠ¤ä¼ è¾“ä¸­çš„æŒå¡äººæ•°æ®

> åœ¨å¼€æ”¾çš„å…¬å…±ç½‘ç»œä¸Šä¼ è¾“æŒå¡äººæ•°æ®æ—¶ä½¿ç”¨å¼ºåŠ å¯†

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 4.2.1 | ä½¿ç”¨å¼ºåŠ å¯†åè®®ä¿æŠ¤ä¼ è¾“ | TLS 1.2/1.3 + å¼ºåŠ å¯†å¥—ä»¶ | `nginx.conf` |
| 4.2.1.1 | ä»…ä½¿ç”¨å¯ä¿¡è¯ä¹¦ | æ”¯æŒ Let's Encrypt / CA ç­¾å‘è¯ä¹¦ | `docker-compose-secrets.yml` |
| 4.2.1.2 | ç¦ç”¨å¼±åŠ å¯†åè®®å’Œç®—æ³• | ç¦ç”¨ SSL 3.0ã€TLS 1.0ã€TLS 1.1 | `nginx.conf` |
| 4.2.2 | ç¡®ä¿æ— çº¿ä¼ è¾“åŠ å¯† | HSTS å¼ºåˆ¶æµè§ˆå™¨ä½¿ç”¨ HTTPS | `nginx.conf` |

**TLS é…ç½®è¯¦ç»†å‚æ•°**ï¼š

| å‚æ•° | é…ç½®å€¼ | PCI DSS è¦æ±‚ |
|------|--------|-------------|
| `ssl_protocols` | `TLSv1.2 TLSv1.3` | ä»…å…è®¸ TLS 1.2+ |
| `ssl_ciphers` | ECDHE + AEAD å¥—ä»¶ | ç¦æ­¢ RC4ã€DESã€3DES |
| `ssl_prefer_server_ciphers` | `on` | æœåŠ¡å™¨ç«¯å†³å®šåŠ å¯†å¥—ä»¶ |
| `ssl_session_timeout` | `1d` | åˆç†çš„ä¼šè¯è¶…æ—¶ |
| `ssl_session_tickets` | `off` | ç¦ç”¨ä¼šè¯ç¥¨æ®ï¼ˆå‰å‘ä¿å¯†ï¼‰ |
| `ssl_stapling` | `on` | OCSP Stapling |
| `ssl_dhparam` | `2048+ bit` | DH å‚æ•° â‰¥ 2048 ä½ |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# å…¨é¢ TLS æµ‹è¯•
echo | openssl s_client -connect localhost:443 2>/dev/null | openssl x509 -noout -text | grep -E "Signature|Public-Key"

# éªŒè¯ç¦ç”¨å¼±åè®®
openssl s_client -connect localhost:443 -tls1 </dev/null 2>&1 | grep -i "error\|alert"
openssl s_client -connect localhost:443 -tls1_1 </dev/null 2>&1 | grep -i "error\|alert"
# é¢„æœŸï¼šè¿æ¥å¤±è´¥

# éªŒè¯åŠ å¯†å¥—ä»¶å¼ºåº¦
nmap --script ssl-enum-ciphers -p 443 localhost 2>/dev/null | grep -E "TLSv|cipher"

# åœ¨çº¿æµ‹è¯•ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
# è®¿é—® https://www.ssllabs.com/ssltest/
# ç›®æ ‡è¯„çº§ï¼šA+
```

### è¦æ±‚ 5ï¼šä¿æŠ¤æ‰€æœ‰ç³»ç»Ÿå…å—æ¶æ„è½¯ä»¶ä¾µå®³

> ä¿æŠ¤æ‰€æœ‰ç³»ç»Ÿå’Œç½‘ç»œå…å—æ¶æ„è½¯ä»¶ä¾µå®³

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 5.2.1 | éƒ¨ç½²é˜²æ¶æ„è½¯ä»¶è§£å†³æ–¹æ¡ˆ | ModSecurity WAF + OWASP CRS è§„åˆ™é›† | `Dockerfile` |
| 5.2.2 | æ£€æµ‹å’Œé˜»æ­¢å·²çŸ¥æ”»å‡» | WAF è§„åˆ™é˜»æ­¢ SQL æ³¨å…¥ã€XSS ç­‰ | `nginx.conf` |
| 5.3.1 | é˜²æ¶æ„è½¯ä»¶æœºåˆ¶ä¿æŒæ´»è·ƒ | ModSecurity è¿è¡Œæ—¶æ£€æµ‹ | `docker-compose.yml` |
| 5.3.2 | å®šæœŸæ›´æ–°ç­¾å | OWASP CRS è§„åˆ™é›†å®šæœŸæ›´æ–° | è¿ç»´æµç¨‹ |

**ModSecurity WAF é˜²æŠ¤èŒƒå›´**ï¼š

| æ”»å‡»ç±»å‹ | WAF è§„åˆ™ | é˜²æŠ¤æ•ˆæœ |
|---------|---------|---------|
| SQL æ³¨å…¥ | OWASP CRS 942xxx | é˜»æ­¢ SQL æ³¨å…¥å°è¯• |
| XSS è·¨ç«™è„šæœ¬ | OWASP CRS 941xxx | é˜»æ­¢åå°„å‹å’Œå­˜å‚¨å‹ XSS |
| è¿œç¨‹å‘½ä»¤æ‰§è¡Œ | OWASP CRS 932xxx | é˜»æ­¢ OS å‘½ä»¤æ³¨å…¥ |
| è·¯å¾„éå† | OWASP CRS 930xxx | é˜»æ­¢ç›®å½•éå†æ”»å‡» |
| æ–‡ä»¶åŒ…å« | OWASP CRS 931xxx | é˜»æ­¢æœ¬åœ°/è¿œç¨‹æ–‡ä»¶åŒ…å« |
| è¯·æ±‚èµ°ç§ | OWASP CRS 921xxx | é˜»æ­¢ HTTP è¯·æ±‚èµ°ç§ |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# æµ‹è¯• SQL æ³¨å…¥é˜²æŠ¤
curl -s "https://localhost:8443/?id=1' OR '1'='1" -o /dev/null -w "%{http_code}"
# é¢„æœŸï¼š403

# æµ‹è¯• XSS é˜²æŠ¤
curl -s "https://localhost:8443/?q=<script>alert(1)</script>" -o /dev/null -w "%{http_code}"
# é¢„æœŸï¼š403

# æµ‹è¯•è·¯å¾„éå†é˜²æŠ¤
curl -s "https://localhost:8443/../../../etc/passwd" -o /dev/null -w "%{http_code}"
# é¢„æœŸï¼š403 æˆ– 400
```

### è¦æ±‚ 6ï¼šå¼€å‘å’Œç»´æŠ¤å®‰å…¨çš„ç³»ç»Ÿå’Œè½¯ä»¶

> å¼€å‘å’Œç»´æŠ¤å®‰å…¨çš„ç³»ç»Ÿå’Œè½¯ä»¶

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 6.2.1 | å®šä¹‰å’Œå®æ–½å®‰å…¨çš„è½¯ä»¶å¼€å‘æµç¨‹ | å¤šé˜¶æ®µ Docker æ„å»º + æœ€å°åŒ–é•œåƒ | `Dockerfile` |
| 6.2.4 | é˜²æ­¢å¸¸è§çš„è½¯ä»¶æ”»å‡» | å®‰å…¨å¤´ + WAF + è¾“å…¥éªŒè¯ | `nginx.conf` |
| 6.3.1 | è¯†åˆ«å’Œç®¡ç†å®‰å…¨æ¼æ´ | é•œåƒæ¼æ´æ‰«æ | CI/CD é›†æˆ |
| 6.3.2 | ç»´æŠ¤è½¯ä»¶ç»„ä»¶æ¸…å• | Dockerfile æ˜ç¡®ç‰ˆæœ¬å· | `Dockerfile` |
| 6.3.3 | åŠæ—¶å®‰è£…å®‰å…¨è¡¥ä¸ | å®šæœŸé‡å»ºé•œåƒ | è¿ç»´æµç¨‹ |
| 6.4.1 | é¢å‘å…¬ä¼—çš„ Web åº”ç”¨é˜²æŠ¤ | ModSecurity WAF | `Dockerfile`ã€`nginx.conf` |
| 6.4.2 | è‡ªåŠ¨åŒ–æŠ€æœ¯æ£€æµ‹å’Œé˜²æ­¢æ”»å‡» | WAF + é€Ÿç‡é™åˆ¶ | `nginx.conf` |

**è¡¥ä¸ç®¡ç†æµç¨‹**ï¼š

```bash
# 1. æ£€æŸ¥åŸºç¡€é•œåƒæ›´æ–°
docker pull alpine:latest

# 2. æ‰«æé•œåƒæ¼æ´
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image nginx-hardened:latest

# 3. é‡å»ºé•œåƒ
docker build --no-cache -t nginx-hardened:latest .

# 4. è¿è¡ŒéªŒè¯æµ‹è¯•
bash tests/validate.sh

# 5. æ»šåŠ¨æ›´æ–°éƒ¨ç½²
docker compose up -d --force-recreate
```

### è¦æ±‚ 7ï¼šæŒ‰ä¸šåŠ¡éœ€è¦é™åˆ¶å¯¹ç³»ç»Ÿç»„ä»¶çš„è®¿é—®

> æŒ‰ä¸šåŠ¡çŸ¥å…¶æ‰€éœ€é™åˆ¶å¯¹æŒå¡äººæ•°æ®çš„è®¿é—®

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 7.1.1 | å®šä¹‰è®¿é—®æ§åˆ¶ç­–ç•¥ | æœ€å°æƒé™åŸåˆ™ | é¡¹ç›®å…¨éƒ¨æ–‡ä»¶ |
| 7.2.1 | åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ | Nginx ä»¥é root ç”¨æˆ·è¿è¡Œ | `Dockerfile` |
| 7.2.2 | åˆ†é…æœ€å°å¿…è¦æƒé™ | `cap_drop: ALL` + æœ€å° `cap_add` | `docker-compose.yml` |
| 7.2.4 | é™åˆ¶ç®¡ç†å‘˜æƒé™ | Docker ç”¨æˆ·ç»„é™åˆ¶ + å®¡è®¡ | `docker-audit.rules` |
| 7.2.5 | è®¿é—®æƒé™å®šæœŸå®¡æŸ¥ | éªŒè¯è„šæœ¬æ£€æŸ¥æƒé™é…ç½® | `validate.sh` |

**æƒé™æ¶æ„**ï¼š

```
ä¸»æœºå±‚é¢
â”œâ”€â”€ Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆrootï¼‰
â”‚   â”œâ”€â”€ å®¡è®¡æ‰€æœ‰æ“ä½œï¼ˆauditdï¼‰
â”‚   â””â”€â”€ é™åˆ¶ docker ç”¨æˆ·ç»„
â”‚
å®¹å™¨å±‚é¢
â”œâ”€â”€ Master è¿›ç¨‹ï¼ˆroot â†’ å—é™ï¼‰
â”‚   â”œâ”€â”€ cap_drop: ALL
â”‚   â”œâ”€â”€ cap_add: ä»…å¿…è¦ Capabilities
â”‚   â”œâ”€â”€ no-new-privileges: true
â”‚   â””â”€â”€ read_only: true
â”‚
â”œâ”€â”€ Worker è¿›ç¨‹ï¼ˆnginx ç”¨æˆ·ï¼‰
â”‚   â”œâ”€â”€ éç‰¹æƒç”¨æˆ·è¿è¡Œ
â”‚   â”œâ”€â”€ æ—  shell è®¿é—®
â”‚   â””â”€â”€ æ–‡ä»¶ç³»ç»Ÿåªè¯»
â”‚
â””â”€â”€ Seccomp + AppArmorï¼ˆå†…æ ¸å±‚é¢é™åˆ¶ï¼‰
```

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# éªŒè¯é root è¿è¡Œ
docker exec nginx-secure id
# æˆ–
docker exec nginx-secure ps aux | head -5

# éªŒè¯ Capabilities
docker inspect --format '{{.HostConfig.CapDrop}}' nginx-secure
# é¢„æœŸï¼š[ALL]

docker inspect --format '{{.HostConfig.CapAdd}}' nginx-secure
# é¢„æœŸï¼šä»…åŒ…å«å¿…è¦çš„ Capabilities

# éªŒè¯åªè¯»æ–‡ä»¶ç³»ç»Ÿ
docker inspect --format '{{.HostConfig.ReadonlyRootfs}}' nginx-secure
# é¢„æœŸï¼štrue
```

### è¦æ±‚ 8ï¼šè¯†åˆ«ç”¨æˆ·å¹¶éªŒè¯å¯¹ç³»ç»Ÿç»„ä»¶çš„è®¿é—®

> è¯†åˆ«å’ŒéªŒè¯å¯¹ç³»ç»Ÿç»„ä»¶çš„è®¿é—®

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 8.2.1 | ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ†é…å”¯ä¸€ ID | å®¹å™¨ä½¿ç”¨ä¸“ç”¨ nginx ç”¨æˆ· (UID 101) | `Dockerfile` |
| 8.2.2 | ç®¡ç†å…±äº«/ç»„è´¦æˆ· | ç¦æ­¢ root ç›´æ¥ç™»å½•å®¹å™¨ | `Dockerfile` |
| 8.3.1 | ä½¿ç”¨å¼ºè®¤è¯æ–¹å¼ | æ— å¯†ç è®¤è¯ï¼ˆåŸºäº Secrets çš„è¯ä¹¦è®¤è¯ï¼‰ | `docker-compose-secrets.yml` |
| 8.6.1 | ç®¡ç†ç³»ç»Ÿå’Œåº”ç”¨è´¦æˆ· | é root ç”¨æˆ· + æ—  shell | `Dockerfile` |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# éªŒè¯ç”¨æˆ·é…ç½®
docker exec nginx-secure cat /etc/passwd | grep nginx
# é¢„æœŸï¼šnginx:x:101:101:...:/nonexistent:/sbin/nologin

# éªŒè¯æ— æ³•ä»¥ root æ‰§è¡Œå‘½ä»¤
docker exec -u root nginx-secure whoami 2>&1
# æ³¨æ„ï¼šå¦‚æœè®¾ç½®äº† user: nginxï¼Œåˆ™åªèƒ½ä»¥ nginx ç”¨æˆ·æ‰§è¡Œ
```

### è¦æ±‚ 10ï¼šè®°å½•å’Œç›‘æ§å¯¹ç³»ç»Ÿç»„ä»¶çš„æ‰€æœ‰è®¿é—®

> è®°å½•å’Œç›‘æ§å¯¹ç½‘ç»œèµ„æºå’ŒæŒå¡äººæ•°æ®çš„æ‰€æœ‰è®¿é—®

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 10.1.1 | å®æ–½å®¡è®¡è¿½è¸ª | auditd + Docker æ—¥å¿— + Nginx æ—¥å¿— | `docker-audit.rules`ã€`daemon.json` |
| 10.2.1 | è®°å½•æ‰€æœ‰ç”¨æˆ·è®¿é—® | Nginx è®¿é—®æ—¥å¿— | `nginx.conf` |
| 10.2.1.1 | è®°å½•ç®¡ç†æ“ä½œ | auditd ç›‘æ§ Docker å‘½ä»¤ | `docker-audit.rules` |
| 10.2.1.2 | è®°å½•ç‰¹æƒæ“ä½œ | auditd ç›‘æ§ Docker æ–‡ä»¶ | `docker-audit.rules` |
| 10.2.1.3 | è®°å½•å®¡è®¡æ—¥å¿—çš„è®¿é—®å’Œä¿®æ”¹ | auditd ä¿æŠ¤æœºåˆ¶ | `docker-audit.rules` |
| 10.2.2 | è®°å½•å¼‚å¸¸æ´»åŠ¨ | ModSecurity WAF å®¡è®¡æ—¥å¿— | `nginx.conf` |
| 10.3.1 | æ—¥å¿—ä¿æŠ¤ä¸è¢«ä¿®æ”¹ | åªè¯»æ–‡ä»¶ç³»ç»Ÿ + æ—¥å¿—è½¬å‘ | `docker-compose.yml` |
| 10.3.3 | æ—¥å¿—åŠæ—¶å¤‡ä»½ | æ”¯æŒè¿œç¨‹æ—¥å¿—ä¼ è¾“ | `daemon.json` |
| 10.4.1 | å®¡æŸ¥æ—¥å¿—ä»¥è¯†åˆ«å¼‚å¸¸ | é›†ä¸­æ—¥å¿—åˆ†æ | `daemon.json` |
| 10.5.1 | æ—¥å¿—ä¿ç•™è‡³å°‘ 12 ä¸ªæœˆ | æ—¥å¿—å½’æ¡£ç­–ç•¥ | è¿ç»´æµç¨‹ |
| 10.7.1 | åŠæ—¶å“åº”å®‰å…¨äº‹ä»¶ | å‘Šè­¦è§„åˆ™é…ç½® | ç›‘æ§ç³»ç»Ÿé›†æˆ |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# éªŒè¯å®¡è®¡è§„åˆ™å·²åŠ è½½
sudo auditctl -l | grep docker | wc -l
# é¢„æœŸï¼š>= 10

# éªŒè¯ Docker æ—¥å¿—å¯ç”¨
docker logs nginx-secure | head -5

# éªŒè¯ Nginx è®¿é—®æ—¥å¿—æ ¼å¼
docker exec nginx-secure tail -1 /var/log/nginx/access.log
# é¢„æœŸï¼šåŒ…å« IPã€æ—¶é—´ã€è¯·æ±‚ã€çŠ¶æ€ç ç­‰å­—æ®µ
```

### è¦æ±‚ 11ï¼šå®šæœŸæµ‹è¯•å®‰å…¨ç³»ç»Ÿå’Œæµç¨‹

> å®šæœŸæµ‹è¯•å®‰å…¨ç³»ç»Ÿå’Œç½‘ç»œ

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° | å®ç°æ–‡ä»¶ |
|-------------|---------|-----------|---------|
| 11.3.1 | å®šæœŸæ‰§è¡Œå†…éƒ¨æ¼æ´æ‰«æ | é•œåƒæ¼æ´æ‰«æï¼ˆTrivyï¼‰ | CI/CD é›†æˆ |
| 11.3.2 | å®šæœŸæ‰§è¡Œå¤–éƒ¨æ¼æ´æ‰«æ | SSL Labs / Mozilla Observatory | åœ¨çº¿æµ‹è¯• |
| 11.4.1 | æ‰§è¡Œæ¸—é€æµ‹è¯• | è‡ªåŠ¨åŒ–å®‰å…¨éªŒè¯è„šæœ¬ | `validate.sh` |
| 11.5.1 | æ£€æµ‹å…³é”®æ–‡ä»¶å˜æ›´ | åªè¯»æ–‡ä»¶ç³»ç»Ÿ + auditd | `docker-compose.yml`ã€`docker-audit.rules` |

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# è¿è¡Œè‡ªåŠ¨åŒ–éªŒè¯
bash tests/validate.sh

# é•œåƒæ¼æ´æ‰«æ
docker run --rm aquasec/trivy image nginx-hardened:latest

# CIS Docker åŸºå‡†æ£€æŸ¥
sudo bash security/cis-docker-benchmark/docker-bench-check.sh
```

### è¦æ±‚ 12ï¼šé€šè¿‡ç­–ç•¥æ”¯æŒä¿¡æ¯å®‰å…¨

> ç»´æŠ¤è§£å†³ä¿¡æ¯å®‰å…¨çš„ç­–ç•¥å’Œç¨‹åº

| PCI DSS æ¡æ¬¾ | è¦æ±‚è¯´æ˜ | æœ¬é¡¹ç›®å®ç° |
|-------------|---------|-----------|
| 12.1.1 | ç»´æŠ¤ä¿¡æ¯å®‰å…¨ç­–ç•¥ | ğŸ“‹ é¡¹ç›® README å’Œå®‰å…¨æ–‡æ¡£ä½œä¸ºç­–ç•¥å‚è€ƒ |
| 12.3.1 | è®°å½•å’Œç¡®è®¤é£é™©è¯„ä¼° | ğŸ“‹ CIS åŸºå‡†æ£€æŸ¥æŠ¥å‘Š |
| 12.3.4 | ç®¡ç†åŠ å¯†å®ç° | âœ… TLS é…ç½®æ–‡æ¡£å’ŒéªŒè¯æ–¹æ³• |
| 12.6.1 | å®‰å…¨æ„è¯†åŸ¹è®­ | ğŸ“‹ å„ README åŒ…å«å®‰å…¨è¯´æ˜å’Œæœ€ä½³å®è·µ |

## éªŒè¯ PCI DSS åˆè§„

### è‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥

```bash
#!/bin/bash
echo "========================================="
echo "PCI DSS åˆè§„å¿«é€Ÿæ£€æŸ¥"
echo "========================================="

echo ""
echo "[è¦æ±‚ 1] ç½‘ç»œå®‰å…¨æ§åˆ¶"
echo -n "  å®¹å™¨é—´é€šä¿¡å·²ç¦æ­¢: "
docker network inspect bridge 2>/dev/null | grep -q '"com.docker.network.bridge.enable_icc": "false"' && echo "PASS" || echo "FAIL"

echo ""
echo "[è¦æ±‚ 2] å®‰å…¨é…ç½®"
echo -n "  éé»˜è®¤é…ç½®: "
curl -s https://localhost:8443/ | grep -qi "welcome to nginx" && echo "FAIL" || echo "PASS"

echo ""
echo "[è¦æ±‚ 4] ä¼ è¾“åŠ å¯†"
echo -n "  TLS 1.2 æ”¯æŒ: "
echo | openssl s_client -connect localhost:443 -tls1_2 2>/dev/null | grep -q "Verify" && echo "PASS" || echo "FAIL"

echo -n "  TLS 1.0 å·²ç¦ç”¨: "
echo | openssl s_client -connect localhost:443 -tls1 2>&1 | grep -qi "error\|alert" && echo "PASS" || echo "FAIL"

echo ""
echo "[è¦æ±‚ 5] WAF é˜²æŠ¤"
echo -n "  SQL æ³¨å…¥é˜»æ­¢: "
STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://localhost:8443/?id=1%27%20OR%20%271%27=%271")
[ "$STATUS" = "403" ] && echo "PASS" || echo "FAIL"

echo ""
echo "[è¦æ±‚ 7] æœ€å°æƒé™"
echo -n "  Capabilities é™åˆ¶: "
CAPS=$(docker inspect --format '{{.HostConfig.CapDrop}}' nginx-secure 2>/dev/null)
echo "$CAPS" | grep -q "ALL" && echo "PASS" || echo "FAIL"

echo -n "  åªè¯»æ–‡ä»¶ç³»ç»Ÿ: "
RO=$(docker inspect --format '{{.HostConfig.ReadonlyRootfs}}' nginx-secure 2>/dev/null)
[ "$RO" = "true" ] && echo "PASS" || echo "FAIL"

echo ""
echo "[è¦æ±‚ 10] æ—¥å¿—å’Œç›‘æ§"
echo -n "  å®¡è®¡è§„åˆ™å·²åŠ è½½: "
RULES=$(sudo auditctl -l 2>/dev/null | grep -c docker)
[ "$RULES" -ge 10 ] && echo "PASS ($RULES rules)" || echo "FAIL ($RULES rules)"

echo ""
echo "========================================="
echo "æ£€æŸ¥å®Œæˆ"
echo "========================================="
```

### åˆè§„æŠ¥å‘Šç”Ÿæˆ

å»ºè®®å®šæœŸï¼ˆè‡³å°‘æ¯å­£åº¦ï¼‰ç”Ÿæˆä»¥ä¸‹æŠ¥å‘Šï¼š

1. **CIS Docker Benchmark æŠ¥å‘Š**ï¼š`sudo bash docker-bench-check.sh > report.txt`
2. **æ¼æ´æ‰«ææŠ¥å‘Š**ï¼š`trivy image nginx-hardened:latest --format json > vuln-report.json`
3. **SSL/TLS è¯„ä¼°æŠ¥å‘Š**ï¼šé€šè¿‡ SSL Labs åœ¨çº¿æµ‹è¯•
4. **æ—¥å¿—å®¡è®¡æŠ¥å‘Š**ï¼š`sudo aureport --summary > audit-report.txt`

---

## å‚è€ƒèµ„æ–™

- [PCI DSS v4.0 å®˜æ–¹æ–‡æ¡£](https://www.pcisecuritystandards.org/document_library/)
- [PCI DSS å¿«é€Ÿå‚è€ƒæŒ‡å—](https://www.pcisecuritystandards.org/pdfs/pci_ssc_quick_guide.pdf)
- [CIS Docker Benchmark](https://www.cisecurity.org/benchmark/docker)
- [CIS Nginx Benchmark](https://www.cisecurity.org/benchmark/nginx)
- [OWASP å®‰å…¨æµ‹è¯•æŒ‡å—](https://owasp.org/www-project-web-security-testing-guide/)
