# =======================================================
# Nginx Docker Compose Secrets 配置示例
# 演示如何使用 Docker Secrets 管理敏感信息
# 基于 CIS Docker Benchmark 安全基准
# =======================================================
#
# 使用方法:
#   1. 准备密钥文件:
#      mkdir -p ./secrets
#      cp /path/to/server.crt ./secrets/ssl_cert.pem
#      cp /path/to/server.key ./secrets/ssl_key.pem
#      htpasswd -c ./secrets/htpasswd admin
#
#   2. 启动服务:
#      docker compose -f docker-compose-secrets.yml up -d
#
#   3. 验证 Secrets 已挂载:
#      docker exec nginx ls -la /run/secrets/
#

services:
  nginx:
    build:
      context: ../..
      dockerfile: Dockerfile
      # 构建参数（取消注释以自定义）
      # args:
      #   USE_modsecurity: "true"
      #   USE_owasp: "true"
      #   NGINX_FAKE_NAME: "OWASP WAF"
    image: nginx:latest
    container_name: nginx

    # 端口映射
    ports:
      - "80:80"
      - "443:443"

    # ==========================================================
    # Docker Secrets 配置
    # 将敏感文件以 tmpfs 方式挂载到容器内 /run/secrets/ 目录
    # 比 bind mount 更安全：仅存于内存，不写入磁盘
    # ==========================================================
    secrets:
      # SSL 证书（公钥）- 权限 0444（所有用户可读）
      - source: ssl_cert
        target: /opt/nginx/ssl/server.crt
        uid: "0"
        gid: "0"
        mode: 0444

      # SSL 私钥 - 权限 0400（仅 root 可读，保护私钥安全）
      - source: ssl_key
        target: /opt/nginx/ssl/server.key
        uid: "0"
        gid: "0"
        mode: 0400

      # HTTP 基本认证密码文件 - 权限 0400（仅 root 可读）
      - source: nginx_htpasswd
        target: /opt/nginx/conf/htpasswd
        uid: "0"
        gid: "0"
        mode: 0400

    # 数据卷（使用命名卷，首次运行自动从镜像初始化）
    volumes:
      - nginx-conf:/opt/nginx/conf            # Nginx 配置文件
      - nginx-confd:/opt/nginx/conf.d          # 网站配置文件
      - nginx-logs:/opt/nginx/logs             # 日志文件
      - wwwroot:/www/wwwroot                   # 网站根目录
      - owasp:/opt/owasp                       # OWASP 规则集
      - nginx-cache:/var/cache/nginx           # Nginx 缓存
      # 注意：SSL 目录由 Secrets 管理，不再需要 nginx-ssl 卷

    # ============================================================
    # CIS Docker Benchmark 安全配置
    # ============================================================

    # CIS 5.25 - 限制容器获取额外权限
    security_opt:
      - no-new-privileges:true

    # CIS 5.3 - 限制 Linux 内核能力
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE    # 绑定低端口 (80/443)
      - CHOWN               # 修改文件属主
      - SETUID              # 切换用户（master→worker）
      - SETGID              # 切换用户组
      - DAC_OVERRIDE        # 文件权限覆盖

    # CIS 5.10/5.11 - 资源限制（防止资源耗尽攻击）
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "4.0"
          pids: 200
        reservations:
          memory: 256M
          cpus: "0.5"

    # CIS 5.12 - 限制容器重启策略
    restart: unless-stopped

    # CIS 5.12 - 只读根文件系统（最小攻击面）
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
      - /run:rw,noexec,nosuid,size=8m

    # CIS 5.26 - 健康检查
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1/nginx-health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # 日志配置（防止日志无限增长）
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        tag: "nginx"

    # CIS 5.18 - 限制共享内存
    shm_size: "256m"

    # 容器主机名
    hostname: nginx

    # 网络配置
    networks:
      - nginx-network

# ==========================================================
# Secrets 定义
# 使用基于文件的 Secrets（适用于 docker compose）
# 文件内容在启动时加载到内存，不会持久化到容器文件系统
# ==========================================================
secrets:
  # SSL 证书文件（公钥）
  ssl_cert:
    file: ./secrets/ssl_cert.pem

  # SSL 私钥文件（务必严格保护此文件的访问权限）
  ssl_key:
    file: ./secrets/ssl_key.pem

  # HTTP 基本认证密码文件（由 htpasswd 命令生成）
  nginx_htpasswd:
    file: ./secrets/htpasswd

# 命名卷定义
volumes:
  nginx-conf:
    name: nginx-conf
  nginx-confd:
    name: nginx-confd
  nginx-logs:
    name: nginx-logs
  wwwroot:
    name: wwwroot
  owasp:
    name: owasp
  nginx-cache:
    name: nginx-cache

# 网络定义
networks:
  nginx-network:
    name: nginx-network
    driver: bridge
