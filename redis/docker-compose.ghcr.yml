# =======================================================
# Redis Docker Compose - 拉取预构建镜像（从 Docker Hub）
# 适用于：直接使用 GitHub Actions 预构建的镜像，无需本地编译
# =======================================================
#
# 使用方法:
#   1. 修改下方 image 地址为你的 Docker Hub 镜像地址
#   2. 启动: docker compose -f docker-compose.ghcr.yml up -d
#   3. 停止: docker compose -f docker-compose.ghcr.yml down
#   4. 日志: docker compose -f docker-compose.ghcr.yml logs -f redis
#
# 首次使用需要登录 Docker Hub（避免在命令行直接暴露 Token）:
#   cat ~/dockerhub_token.txt | docker login -u <你的Docker Hub用户名> --password-stdin
#
# 如果镜像是公开的（Public），则不需要登录即可拉取
#

services:
  redis:
    # ================================================================
    # ⚠️ 请修改为你自己的镜像地址
    # 格式: <Docker Hub用户名>/redis:latest
    # 示例: mzwrt/redis:latest
    # ================================================================
    image: mzwrt/redis:latest
    container_name: redis

    # 端口映射（通常 Redis 不需要暴露端口，通过 Docker 网络与 PHP 通信）
    # ports:
    #   - "36379:36379"

    # 环境变量
    environment:
      # 设置 Redis 密码（取消注释以启用）
      # REDIS_PASSWORD: "your_secure_password_here"
      TZ: Asia/Shanghai

    # 数据卷（使用命名卷，首次运行自动从镜像初始化）
    volumes:
      - redis-conf:/opt/redis/etc              # Redis 配置文件
      - redis-data:/opt/redis/data             # Redis 数据目录
      - redis-logs:/opt/redis/var/log          # Redis 日志

    # ============================================================
    # CIS Docker Benchmark 安全配置
    # ============================================================

    # CIS 5.25 - 限制容器获取额外权限
    security_opt:
      - no-new-privileges:true

    # CIS 5.3 - 限制 Linux 内核能力
    cap_drop:
      - ALL
    cap_add:
      - CHOWN               # 修改文件属主
      - SETUID              # 切换用户
      - SETGID              # 切换用户组
      - DAC_OVERRIDE        # 文件权限覆盖

    # CIS 5.10/5.11 - 资源限制（防止资源耗尽攻击）
    # 注意：容器内存限制 (2G) 高于 Redis maxmemory (512mb)，为系统开销预留空间
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "4.0"
          pids: 200
        reservations:
          memory: 256M
          cpus: "0.5"

    # CIS 5.12 - 限制容器重启策略
    restart: unless-stopped

    # CIS 5.12 - 只读根文件系统（最小攻击面）
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=256m
      - /run:rw,noexec,nosuid,size=8m

    # CIS 5.26 - 健康检查
    healthcheck:
      test: ["CMD-SHELL", "redis-healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # 日志配置（防止日志无限增长）
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        tag: "redis"

    # CIS 5.18 - 限制共享内存
    shm_size: "256m"

    # 容器主机名
    hostname: redis

    # 网络配置
    networks:
      - nginx-network

# 命名卷定义
volumes:
  redis-conf:
    name: redis-conf
  redis-data:
    name: redis-data
  redis-logs:
    name: redis-logs

# 网络定义
networks:
  nginx-network:
    name: nginx-network
    driver: bridge
