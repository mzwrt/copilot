; =======================================================
; PHP-FPM 进程池配置 (www.conf)
; 路径: /opt/php/etc/php-fpm.d/www.conf
; =======================================================

[www]
; 运行用户和用户组
user = www-data
group = www-data

; 监听地址（TCP 端口，便于 Docker 网络通信）
listen = 0.0.0.0:9000

; 监听权限（用于 Unix Socket 模式）
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; 允许连接的客户端 IP（留空允许所有）
listen.allowed_clients =

; ============================================================
; 进程管理模式
; static   - 固定数量的子进程
; dynamic  - 动态调整子进程数量（推荐）
; ondemand - 按需创建子进程
; ============================================================
pm = dynamic

; 最大子进程数（需与容器内存限制匹配：20×256MB≈5GB 峰值，容器限制 2GB 足够）
pm.max_children = 20

; 启动时子进程数
pm.start_servers = 5

; 空闲时最少子进程数
pm.min_spare_servers = 2

; 空闲时最多子进程数
pm.max_spare_servers = 10

; 每个子进程处理的最大请求数（防止内存泄漏）
pm.max_requests = 500

; 进程空闲超时（ondemand 模式使用）
pm.process_idle_timeout = 10s

; 状态页面（用于监控）
pm.status_path = /php-fpm-status
ping.path = /php-fpm-ping
ping.response = pong

; 慢日志配置
slowlog = /opt/php/var/log/php-fpm-slow.log
request_slowlog_timeout = 5s

; 请求终止超时
request_terminate_timeout = 300s

; 打开文件描述符限制
rlimit_files = 51200

; 环境变量清理（安全）
clear_env = yes

; 捕获 worker 输出
catch_workers_output = yes

; 装饰 worker 输出
decorate_workers_output = no
