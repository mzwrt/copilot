; =======================================================
; Snuffleupagus 安全规则配置文件
; PHP 运行时安全加固 - 防御常见攻击向量
; 路径: /opt/php/etc/snuffleupagus.rules
;
; 文档: https://snuffleupagus.readthedocs.io/
;
; 注意: 此文件仅在 USE_snuffleupagus=true 构建时生效
; =======================================================

; ============================================================
; Cookie 安全加固
; 设置所有 Cookie 为 HttpOnly + Secure + SameSite=Lax
; 防止 XSS 窃取 Cookie（PCI DSS 合规）
; ============================================================
sp.cookie.name("*").httponly();
sp.cookie.name("*").secure();
sp.cookie.name("*").samesite("lax");

; ============================================================
; 禁止不安全的 PHP 运行时设置
; 防止通过 ini_set() 降低安全级别
; ============================================================
sp.ini.key("assert.active").set("0").drop();
sp.ini.key("zend.assertions").set("-1").drop();

; ============================================================
; 禁用 XML 外部实体处理（防止 XXE 攻击）
; ============================================================
sp.xxe_protection.enable();

; ============================================================
; 限制文件上传的 MIME 类型（可选）
; 如需启用，创建验证脚本后取消注释
; ============================================================
; sp.upload_validation.script("/opt/php/etc/snuffleupagus_upload_check.sh").enable();

; ============================================================
; 防御 mail() 函数注入攻击（可选）
; 限制 mail() 函数仅允许指定来源，取消注释以启用
; 注意：此规则会限制通过外部 SMTP 发送邮件
; ============================================================
; sp.global.mail_allowlist("127.0.0.1").enable();

; ============================================================
; 自动加密 Session 数据（防止 Session 劫持）
; 使用 sodium 库加密，密钥自动从 cookie 派生
; ============================================================
sp.session.encrypt();

; ============================================================
; 限制 eval() 使用（如需完全禁用，取消注释下行）
; ============================================================
; sp.eval.blacklist(".*").drop();
