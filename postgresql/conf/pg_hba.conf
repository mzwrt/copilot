# =======================================================
# PostgreSQL Host-Based Authentication (HBA) Configuration
# 符合 CIS PostgreSQL Benchmark 和 PCI DSS v4.0 安全基准
# =======================================================
#
# TYPE  DATABASE        USER            ADDRESS                 METHOD
#
# 认证方式说明：
#   scram-sha-256  - 最安全的密码认证（CIS 6.7 推荐）
#   reject         - 拒绝连接
#   peer           - Unix socket 系统用户匹配（仅本地）
#
# =======================================================

# ============================================================
# 本地连接（Unix socket）
# ============================================================

# 允许 postgres 超级用户通过 Unix socket 进行本地维护操作
# CIS 推荐：本地连接使用 peer 认证（OS 用户匹配）
local   all             postgres                                peer

# 拒绝其他用户的本地连接（安全：最小权限原则）
# 如需允许，改为 scram-sha-256
local   all             all                                     scram-sha-256

# ============================================================
# IPv4 TCP/IP 连接
# ============================================================

# CIS 6.1 - 仅允许 Docker 内部网络连接（使用 scram-sha-256 认证）
# Docker 默认网络范围：172.16.0.0/12
host    all             all             172.16.0.0/12           scram-sha-256

# Docker 默认 bridge 网络范围
host    all             all             192.168.0.0/16          scram-sha-256

# 本地回环连接
host    all             all             127.0.0.1/32            scram-sha-256

# ============================================================
# IPv6 TCP/IP 连接
# ============================================================

# 本地回环连接 (IPv6)
host    all             all             ::1/128                 scram-sha-256

# ============================================================
# 复制连接（用于主从复制）
# ============================================================

# 允许复制用户从 Docker 网络连接（取消注释以启用）
# host    replication     replication_user  172.16.0.0/12       scram-sha-256

# ============================================================
# 安全说明
# ============================================================
#
# 1. 所有远程连接必须使用 scram-sha-256 认证（CIS 6.7）
# 2. 不使用 trust、password、md5 等不安全认证方式
# 3. 不使用 0.0.0.0/0 允许所有地址连接
# 4. 生产环境建议进一步限制 IP 范围
# 5. 定期审查此文件的连接规则（PCI DSS 7.2）
#
