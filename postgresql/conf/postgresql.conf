# =======================================================
# PostgreSQL Configuration File
# Security-hardened configuration for Docker deployment
# 符合 CIS PostgreSQL Benchmark 和 PCI DSS v4.0 安全基准
# =======================================================

# ================================
# CONNECTION AND AUTHENTICATION
# ================================

# 监听所有接口（Docker 网络）
listen_addresses = '0.0.0.0'

# 自定义高端口（避免默认 5432，降低被扫描风险）
port = 55432

# 最大连接数（高并发优化）
max_connections = 200

# 超级用户保留连接数
superuser_reserved_connections = 5

# Unix socket 目录
unix_socket_directories = '/opt/postgresql/var/run'
unix_socket_permissions = 0700

# CIS 6.2 - 连接认证超时（秒）
authentication_timeout = 30s

# CIS 6.7 - 密码加密方式（使用最安全的 scram-sha-256）
password_encryption = scram-sha-256

# ================================
# RESOURCE USAGE (Memory)
# ================================

# 共享缓冲区（建议为可用内存的 25%，容器内存 4G 时设为 512MB-1GB）
shared_buffers = 512MB

# 工作内存（每个排序/哈希操作）
work_mem = 16MB

# 维护操作内存（VACUUM、CREATE INDEX 等）
maintenance_work_mem = 256MB

# 有效缓存大小（帮助查询优化器估算可用内存）
effective_cache_size = 1536MB

# 临时缓冲区
temp_buffers = 32MB

# ================================
# RESOURCE USAGE (Disk)
# ================================

# 临时文件大小限制（防止磁盘空间耗尽 - PCI DSS 安全要求）
temp_file_limit = 1GB

# ================================
# WRITE-AHEAD LOG (WAL)
# ================================

# WAL 级别（支持复制和 PITR）
wal_level = replica

# WAL 缓冲区
wal_buffers = 64MB

# WAL 同步方式（数据安全优先）
synchronous_commit = on
fsync = on
full_page_writes = on

# WAL 压缩（减少 I/O）
wal_compression = lz4

# WAL 目录
# 注意：生产环境建议将 WAL 放在独立磁盘
# 通过 initdb --waldir 指定

# 检查点配置（高性能优化）
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 512MB

# ================================
# REPLICATION
# ================================

# 最大 WAL 发送进程数（用于流复制）
max_wal_senders = 5

# 保留 WAL 段数（用于流复制延迟恢复）
wal_keep_size = 1GB

# ================================
# QUERY TUNING
# ================================

# 随机页面成本（SSD 优化，降低此值鼓励使用索引扫描）
random_page_cost = 1.1

# 有效 I/O 并发
effective_io_concurrency = 200

# 并行查询（高并发优化）
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
max_worker_processes = 16

# JIT 编译（复杂查询性能提升）
jit = on

# ================================
# LOGGING
# ================================

# 日志目标
logging_collector = on
log_directory = '/opt/postgresql/var/log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# CIS 6.8 - 日志记录级别
log_min_messages = warning
log_min_error_statement = error

# CIS 6.9 - 记录连接和断开
log_connections = on
log_disconnections = on

# CIS 6.10 - 记录持续时间
log_duration = off
log_min_duration_statement = 1000

# CIS 6.11 - 日志行前缀（包含安全审计所需信息）
# PCI DSS 10.2 - 审计日志必须包含用户、时间、操作等
log_line_prefix = '%m [%p] user=%u,db=%d,app=%a,client=%h '

# CIS 6.12 - 记录 DDL 语句
log_statement = 'ddl'

# 记录检查点
log_checkpoints = on

# 记录锁等待
log_lock_waits = on

# 记录临时文件使用
log_temp_files = 0

# 日志时区
log_timezone = 'UTC'

# ================================
# SECURITY
# ================================

# CIS 6.3 - 禁用 SSL（Docker 内部网络通信，外部通过 Nginx 终止 TLS）
# 如需启用容器间 TLS，取消注释以下配置
# ssl = on
# ssl_cert_file = '/opt/postgresql/ssl/server.crt'
# ssl_key_file = '/opt/postgresql/ssl/server.key'
# ssl_ca_file = '/opt/postgresql/ssl/ca.crt'
# ssl_min_protocol_version = 'TLSv1.2'
# ssl_ciphers = 'HIGH:!aNULL:!MD5:!3DES:!RC4'
# ssl_prefer_server_ciphers = on

# CIS 6.5 - 行级安全
row_security = on

# 数据校验和（数据完整性保护 - PCI DSS 要求）
# 注意：需要在 initdb 时通过 --data-checksums 启用

# HBA 配置文件路径
hba_file = '/opt/postgresql/etc/pg_hba.conf'

# 密码错误延迟（防止暴力破解）
# 通过 pg_hba.conf 的 auth-delay 模块实现

# ================================
# STATISTICS AND MONITORING
# ================================

# 统计信息收集
track_activities = on
track_counts = on
track_io_timing = on
track_wal_io_timing = on
track_functions = all

# ================================
# AUTOVACUUM
# ================================

# 自动 VACUUM（数据库维护，防止表膨胀）
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.025
autovacuum_vacuum_cost_delay = 2ms

# ================================
# CLIENT DEFAULTS
# ================================

# 搜索路径（安全：不包含 public schema 以防止恶意对象注入）
# CIS 3.2 - 限制搜索路径
search_path = '"$user"'

# 时区
timezone = 'UTC'

# 字符编码
client_encoding = 'UTF8'

# 语句超时（防止长时间运行的查询 - 安全和性能）
statement_timeout = 300000

# 空闲事务超时（防止连接泄漏）
idle_in_transaction_session_timeout = 600000

# 锁等待超时
lock_timeout = 60000

# ================================
# LOCK MANAGEMENT
# ================================

# 死锁检测超时
deadlock_timeout = 1s

# 最大锁数
max_locks_per_transaction = 128

# ================================
# ERROR HANDLING
# ================================

# 数据页校验失败时终止恢复（数据完整性优先）
# data_checksums 必须在 initdb 时启用
# ignore_checksum_failure = off

